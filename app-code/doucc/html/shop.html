<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>shop</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/main.css">
		<style>
			html,body {
				background-color: #efeff4;
			}
			
			
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="padding-right: 15px;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">商城</h1>
		</header>
		<div id="shop-box" class="mui-content mui-scroll-wrapper">
			
			<ul id="product-list" class="mui-scroll mui-table-view mui-table-view-striped mui-table-view-condensed">
				<li class="mui-table-view-cell">
					<div class="mui-slider-cell">
						<div class="mui-table product-item">
							<div class="mui-table-cell shop-img">
								<img src="../images/60x60.gif" />
							</div>
							<div class="mui-table-cell shop-text">
								<div class="mui-clearfix">
									<h4 id="pname" class=""></h4>
									<span id="pprice" class="mui-h5"></span>
								</div>
								
							</div>
							<div class="mui-table-cell shop-action" id="shop-action">
								<button data-id="1" type="button" id="btn-buy" class="mui-btn mui-btn-primary btn-buy">购买</button>
							</div>
							
						</div>
					</div>
				</li>
			
			</ul>
		</div>
	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/main.js"></script>
	<script>
		mui.init({
			swipeBack:true ,//启用右滑关闭功能
			pullRefresh : {
			    container:"#shop-box",//下拉刷新容器标识，querySelector能定位的css选择器均可，比如：id、.class等
			    down : {
			      style:'circle',//必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
			      color:'#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
			      height:'50px',//可选,默认50px.下拉刷新控件的高度,
			      range:'100px', //可选 默认100px,控件可下拉拖拽的范围
			      offset:'0px', //可选 默认0px,下拉刷新控件的起始位置
			      auto: true,//可选,默认false.首次加载自动上拉刷新一次
			      callback : getTaskList //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
			    }
			  }
		});
		mui.plusReady(function() {
			mui.ajax(config.host + 'index.php?s=Product/getProductList', {
				data: getToken(),
				dataType:'json',//服务器返回json格式数据
				type:'post',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				headers:{'Content-Type':'application/json'},
				success:function(data){
					console.log(data)
					//服务器返回响应，根据响应结果，分析是否登录成功；
					if(data.code == 0){
						mui.alert(data.msg);
					}else if(data.code == 2){
						location.href = config.host + 'index.php?s=home/login'	
					}else{
						var p = data.data.data;
						document.getElementById("pname").innerHTML = p.name;
						document.getElementById("pprice").innerHTML = p.price + "元";
						if(data.data.isbuy){
							document.getElementById("shop-action").innerHTML = '<span class="mui-badge mui-badge-purple">已购买</span>';
						}else{
							document.getElementById("btn-buy").setAttribute("data-id", p.id);
						}
						
					}
					
				},
				error:function(xhr,type,errorThrown){
					
				}
			});
			
			
			mui("#product-list").on('tap', '.btn-buy', function(){
				var productid = this.getAttribute("data-id");
				mui.ajax(config.host + 'index.php?s=Order/createOrder', {
					data: Object.assign(getToken(), {productid: productid}),
					dataType:'json',//服务器返回json格式数据
					type:'post',//HTTP请求类型
					timeout:10000,//超时时间设置为10秒；
					headers:{'Content-Type':'application/json'},
					success:function(data){
						console.log(data)
						//服务器返回响应，根据响应结果，分析是否登录成功；
						if(data.code == 0){
							mui.alert(data.msg);
						}else if(data.code == 2){
							
						}else{
							// http://doucc.com/index.php?s=cash/unionpay
							var url = config.host + 'index.php?s=Cash/unionpay&orderid=' + data.data.orderid + "&userid=" + data.data.userid;
							location.href = url;
						   
						 //  plus.webview.create('http://www.baidu.com', 'baidu', {popGesture:'hide',navigationbar:{backgroundColor:'#FFFFFF',titleColor:'#000000',backButton:{color:'#007AFF',colorPressed:'#0000FF'}}}).show('pop-in');
						   
						}
						
					},
					error:function(xhr,type,errorThrown){
						//异常处理；
						// mui.alert("商城");
						console.log(type);
					}
				});
			});
			
					   
			// 访问外部网址返回处理
			/*
			plus.webview.create('http://www.baidu.com', 'baidu', {popGesture:'hide',navigationbar:{backgroundColor:'#FFFFFF',titleColor:'#000000',backButton:{color:'#007AFF',colorPressed:'#0000FF'}}}).show('pop-in'); // debug
			mui.oldBack = mui.back;  
			mui.back = function(event) {  
			    var baidu = plus.webview.getWebviewById('baidu');  
			    if(baidu){  
			        return baidu.canBack( function(e){  
			                if(e.canBack){  
			                        baidu.back();  
			                }else{  
			                        baidu.close();  
			                }  
			        });  
			    }  
			    mui.oldBack();  
			    return false;  
			};
			*/
			
		});
		var getTaskList = function(){
			mui.alert("pull");
			setTimeout(function() {
				
				mui('#shop-box').pullRefresh().endPulldownToRefresh(); //refresh completed
				mui.toast('下拉刷新成功');
			}, 1000);
		};
	</script>
</html>